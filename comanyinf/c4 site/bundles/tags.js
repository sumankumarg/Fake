Object.extend(Event,{KEY_COMMA:188,CHAR_COMMA:44});
Element.addMethods({getCaretPosition:function(){if(this.createTextRange){var a=document.selection.createRange().duplicate();a.moveEnd("character",this.value.length);if(a.text==="")return this.value.length;return this.value.lastIndexOf(a.text)}else return this.selectionStart},cacheData:function(a,b,c){if(Object.isUndefined(this[$(a).identify()])||!Object.isHash(this[$(a).identify()]))this[$(a).identify()]=$H();this[$(a).identify()].set(b,c);return a},retrieveData:function(a,b){return this[$(a).identify()].get(b)},
onBoxDispose:function(a,b){a=a.retrieveData("text").evalJSON(true);a.newValue||b.autoFeed(a)},onInputFocus:function(a,b){b.autoShowInputFocus&&b.autoShowInputFocus()},onInputBlur:function(a,b){b.lastinput=a;if(!b.curOn&&b.autoHide)b.blurhide=b.autoHide.bind(b).delay(0.1)}});Object.extend(String.prototype,{entitizeHTML:function(){return this.replace(/</g,"&lt;").replace(/>/g,"&gt;")},unentitizeHTML:function(){return this.replace(/&lt;/g,"<").replace(/&gt;/g,">")}});
function $pick(){for(var a=0;a<arguments.length;a++)if(!Object.isUndefined(arguments[a]))return arguments[a];return null}
var ResizableTextbox=Class.create({initialize:function(a,b){this.options=$H({minimum:5,maximum:500}).update(b);this.el=$(a);this.measurediv=this.getMeasurementDiv();this.setElementWidth();this.el.observe("keypress",this.setElementWidth.bind(this)).observe("change",this.setElementWidth.bind(this)).observe("keyup",this.setElementWidth.bind(this))},calculateWidth:function(){this.measurediv.update($F(this.el).escapeHTML()+"MM");newsize=this.measurediv.getWidth();if(newsize<this.options.get("minimum"))newsize=
this.options.get("minimum");if(newsize>this.options.get("maximum"))newsize=this.options.get("maximum");return newsize},clear:function(){this.el.clear();this.setElementWidth();return this},focus:function(){this.el.focus();return this},getMeasurementDiv:function(){if($("__resizeable_textbox_measure_div"))a=$("__resizeable_textbox_measure_div");else{var a=new Element("div",{id:"__resizeable_textbox_measure_div"});a.setStyle({position:"absolute",top:"-1000px",left:"-1000px"});$(document.body).insert(a)}return a.setStyle({fontSize:this.el.getStyle("font-size"),
fontFamily:this.el.getStyle("font-family")})},setElementWidth:function(){var a=this.calculateWidth();a>=this.options.get("minimum")&&a<=this.options.get("maximum")&&this.el.setStyle({width:a+"px"})}}),TextboxList=Class.create({initialize:function(a,b){this.options=$H({resizable:{},className:"bit",separator:",",extrainputs:true,startinput:true,onAdd:function(){},onRemove:function(){},hideempty:true,newValues:false,spaceReplace:"",encodeEntities:false,jsonInputValue:false});this.current_input="";this.options.update(b);
this.element=$(a).hide();this.bits=new Hash;this.events=new Hash;this.count=0;this.current=false;this.maininput=this.createInput({"class":"maininput"});this.holder=(new Element("div",{"class":"holder"})).insert(this.maininput);this.element.insert({before:this.holder});this.holder.observe("click",function(c){c.stop();this.focus(this.maininput)}.bind(this));this.makeResizable(this.maininput);this.setEvents()},setEvents:function(){this.holder.observe("keyup",function(a){a.stop();if(!this.current)return null;
switch(a.keyCode){case Event.KEY_LEFT:return this.move("left");case Event.KEY_RIGHT:return this.move("right");case Event.KEY_DELETE:case Event.KEY_BACKSPACE:return this.moveDispose()}return null}.bind(this)).observe(Prototype.Browser.IE||Prototype.Browser.WebKit?"keydown":"keypress",function(a){if(!this.current)return null;this.current.retrieveData("type")=="box"&&a.keyCode==Event.KEY_BACKSPACE&&a.stop();if(this.current.retrieveData("input")&&!this.checkInput())return null;[Event.KEY_HOME,Event.KEY_END].include(a.keyCode)&&
a.stop();switch(a.keyCode){case Event.KEY_HOME:return this.move("home");case Event.KEY_END:return this.move("end")}return null}.bind(this));document.observe("click",function(){this.blur()}.bindAsEventListener(this))},update:function(){var a=this.bits.values();if(this.options.get("jsonInputValue")){this.current_input.blank()||this.current_input.split(/,/).each(function(b){b=b.strip();a.push({caption:b,value:b,newValue:true})}.bindAsEventListener(this));this.element.value=a.toJSON()}else{if(this.options.get("encodeEntities"))a=
a.map(function(b){return b.toString().entitizeHTML().unescapeHTML().unentitizeHTML()});this.element.value=a.join(this.options.get("separator"));this.current_input.blank()||(this.element.value+=(this.element.value.blank()?"":this.options.get("separator"))+this.current_input)}return this},add:function(a,b){var c=this.id_base+"-"+this.count++,d=this.createBox($pick(b,a),{id:c,"class":this.options.get("className"),newValue:a.newValue?"true":"false",href:"#"});(this.current||this.maininput).insert({before:d});
d.observe("click",function(e){e.stop();this.focus(d)}.bind(this));this.options.get("jsonInputValue")?this.bits.set(c,a):this.bits.set(c,a.value);this.update();if(this.options.get("extrainputs")&&(this.options.get("startinput")||d.previous()))this.addSmallInput(d,"before");this.options.get("onAdd")(a);this.options.get("defaultDisplay")>0&&this.setDefaultDisplay();return d},addSmallInput:function(a,b){var c=this.createInput({"class":"smallinput"});a.insert({}[b]=c);c.cacheData("small",true);this.makeResizable(c);
this.options.get("hideempty")&&c.hide();return c},insertCurrent:function(){if(this.options.get("newValues")){var a=this.current.retrieveData("input");a.value=a.value.strip();if(a.value.indexOf(",")<a.value.length-1){var b=a.value.indexOf(",");if(b>0)a.value=a.value.substr(0,b).strip()}else a.value=a.value.strip();this.options.get("spaceReplace").blank()||a.value.gsub(" ",this.options.get("spaceReplace"));if(!a.value.blank()){this.newvalue=true;b=a.value.gsub(",","");b=this.options.get("encodeEntities")?
b.entitizeHTML():b.escapeHTML();a.retrieveData("resizable").clear().focus();this.current_input="";this.add({caption:b,value:b,newValue:true});return true}}return false},dispose:function(a){this.bits.unset(a.id);var b=a.innerHTML.stripScripts();b=this.options.get("encodeEntities")?b.entitizeHTML():b.escapeHTML();this.options.get("onRemove")(b.replace(/[\n\r\s]+/g," "));this.update();a.previous()&&a.previous().retrieveData("small")&&a.previous().remove();this.current==a&&this.focus(a.next());a.retrieveData("type")==
"box"&&a.onBoxDispose(this);a.remove();return this},focus:function(a,b){if(this.current){if(this.current==a)return this}else a.fire("focus");this.blur();a.addClassName(this.options.get("className")+"-"+a.retrieveData("type")+"-focus");a.retrieveData("small")&&a.setStyle({display:"block"});if(a.retrieveData("type")=="input"){a.onInputFocus(this);b||this.callEvent(a.retrieveData("input"),"focus")}else{a.fire("onBoxFocus");this.callEvent(a,"focus")}this.current=a;return this},blur:function(a){if(!this.current)return this;
if(this.current.retrieveData("type")=="input"){var b=this.current.retrieveData("input");a||this.callEvent(b,"blur");b.onInputBlur(this)}else this.current.fire("onBoxBlur");this.current.retrieveData("small")&&!b.get("value")&&this.options.get("hideempty")&&this.current.hide();this.current.removeClassName(this.options.get("className")+"-"+this.current.retrieveData("type")+"-focus");this.current=false;return this},createBox:function(a,b){var c=(new Element("a",b)).addClassName(this.options.get("className")+
"-box").update(a.caption.entitizeHTML()).cacheData("type","box"),d=new Element("a",{href:"#","class":"closebutton"});d.observe("click",function(e){e.stop();this.current||this.focus(this.maininput);this.dispose(c)}.bind(this));c.insert(d).cacheData("text",Object.toJSON(a));return c},createInput:function(a){var b=new Element("a",{"class":this.options.get("className")+"-input"});a=new Element("input",Object.extend(a,{type:"text",autocomplete:"off"}));a.observe("focus",function(){this.isSelfEvent("focus")||
this.focus(b,true)}.bind(this)).observe("blur",function(){this.isSelfEvent("blur")||this.blur(true)}.bind(this)).observe("keydown",function(){this.cacheData("lastvalue",this.value).cacheData("lastcaret",this.getCaretPosition())}).observe("keypress",function(c){var d=c.charCode||c.keyCode;if(c.keyCode==Event.KEY_RETURN||d==Event.CHAR_COMMA)this.insertCurrentValue=true}.bind(this)).observe("keyup",function(c){if(c.keyCode==Event.KEY_RETURN&&!this.insertCurrentValue)this.insertCurrentValue=true;if(this.insertCurrentValue){this.insertCurrent()&&
c.stop();this.insertCurrentValue=false}}.bind(this));return b.cacheData("type","input").cacheData("input",a).insert(a)},callEvent:function(a,b){this.events.set(b,a);a[b]()},isSelfEvent:function(a){return this.events.get(a)?!!this.events.unset(a):false},makeResizable:function(a){a=a.retrieveData("input");a.cacheData("resizable",new ResizableTextbox(a,Object.extend(this.options.get("resizable"),{min:a.offsetWidth,max:this.element.getWidth()?this.element.getWidth():0})));return this},checkInput:function(){var a=
this.current.retrieveData("input");return!a.retrieveData("lastvalue")||a.getCaretPosition()===0&&a.retrieveData("lastcaret")===0},move:function(a){switch(a){case "home":var b=this.current.parentNode.firstDescendant();break;case "end":b=this.current.parentNode.childElements().last();break;default:b=this.current[a=="left"?"previous":"next"]()}if(b&&(!this.current.retrieveData("input")||this.checkInput()||a=="right"))this.focus(b);return this},moveDispose:function(){if(this.current.retrieveData("type")==
"box")return this.dispose(this.current);if(this.checkInput()&&this.bits.keys().length&&this.current.previous())return this.focus(this.current.previous());return null}}),ProtoMultiSelect=Class.create(TextboxList,{initialize:function($super,b,c,d){d=$H({fetchFile:undefined,fetchMethod:"get",fetchParameters:{},results:10,maxResults:0,wordMatch:false,onEmptyInput:function(){},onUserAdd:function(){},onUserRemove:function(){},caseSensitive:false,regexSearch:true,loadFromInput:true,defaultMessage:"",defaultDisplay:-1,
inputMessage:null,sortResults:false,allowDuplicates:false,autoDelay:250,autoResize:false,pinAutoHolder:false,renderItem:null,sortFunction:null,renderBox:null,addOnBlur:false}).update(d);$super(b,d);this.loptions=$H({autocomplete:{opacity:1,maxresults:10,minchars:1}});this.id_base=$(b).identify()+"_"+this.options.get("className");this.data=[];this.data_searchable=[];this.selectedValues=new Hash;this.autoholder=$(c)||this.createAutoholder(c);this.autoholder.setOpacity(this.loptions.get("autocomplete").opacity).observe("mouseover",
function(){this.curOn=true}.bind(this)).observe("mouseout",function(){this.curOn=false}.bind(this));if(this.options.get("autoResize")){this.autoResize();Event.observe(window,"resize",function(){this.autoResize()}.bind(this))}this.autoresults=this.autoholder.select("ul").first();this.autoresults.select("li").each(function(e){this.add({value:e.readAttribute("value"),caption:e.innerHTML})},this);if(Object.isUndefined(this.options.get("fetchFile"))){if(!Object.isUndefined(this.options.get("feed"))){this.options.get("feed").each(function(e){this.autoFeed(e)}.bind(this));
this.options.get("defaultDisplay")>0&&this.setDefaultDisplay()}}else this.loadFromFetchFile();Object.isUndefined(this.options.get("fetchFile"))&&this.options.get("loadFromInput")&&this.loadFromInput();document.observe("click",function(){this.autoHide()}.bindAsEventListener(this));this.inputElem=this.maininput.firstDescendant();if(this.options.get("inputMessage")){b=function(){if(this.inputElem.value.blank()){this.inputElem.setValue(this.options.get("inputMessage"));this.inputElem.addClassName("inputMessage");
this.inputElem.retrieveData("resizable").setElementWidth()}}.bindAsEventListener(this);this.inputElem.observe("blur",b);b();this.inputElem.observe("focus",function(){if(this.inputElem.value==this.options.get("inputMessage")){this.inputElem.setValue("");this.inputElem.removeClassName("inputMessage")}}.bindAsEventListener(this))}this.setDefaultEvents()},setDefaultEvents:function(){this.options.get("addOnBlur")&&this.inputElem.observe("blur",function(){this.autoAdd(this.autocurrent)}.bind(this));if(this.options.get("defaultDisplay")>
0){this.holder.observe("click",function(a){this.current_input.blank()&&this.setDefaultDisplay();a.stop()}.bindAsEventListener(this));this.autoholder.observe("click",function(a){this.current_input.blank()&&this.setDefaultDisplay();a.stop()}.bindAsEventListener(this))}},add:function($super,b){this.autoClear();var c=$super(b);this.selectedValues.set(c.getAttribute("id"),b);return c},dispose:function($super,b){this.options.get("onUserRemove")(this.selectedValues.get(b.getAttribute("id")));this.selectedValues.unset(b.getAttribute("id"));
return $super(b)},foundInData:function(a){return this.data.find(function(b){if(!b)return false;return(b=b.evalJSON(true))&&b.caption.toLowerCase().gsub(" ","")==a.toLowerCase().gsub(" ","")})},foundInSelectedValues:function(a){return this.selectedValues.values().find(function(b){return b&&b.caption&&b.caption.toLowerCase().gsub(" ","")==a.toLowerCase().gsub(" ","")})},isSearchInsertable:function(a){return this.options.get("newValues")&&(this.options.get("allowDuplicates")||!this.foundInSelectedValues(a)&&
!this.foundInData(a))},insertCurrent:function($super){var b=false,c=this.current.retrieveData("input"),d=c.value;if(!d||d=="")return false;d.split(/,/).compact().without("").each(function(e){if(e&&e!=""&&this.isSearchInsertable(e)){e=e.strip();c.value=e;if($super()){this.options.get("onUserAdd")({caption:e,value:e,newValue:true});b=true}}}.bindAsEventListener(this));return b},autoClear:function(){this.autoholder.descendants().each(function(a){a.hide()});this.resultsshown=false},autoShowInputFocus:function(){this.autoShow(this.inputElem.value.escapeHTML());
return true},autoShow:function(a){if(!(this.options.get("inputMessage")&&a==this.options.get("inputMessage"))){this.autoholder.setStyle({display:"block"});this.autoClear();if(!a||!a.strip()||!a.length||a.length<this.loptions.get("autocomplete").minchars){if(this.options.get("defaultDisplay")>0)this.setDefaultDisplay();else this.autoholder.select(".default").first()&&this.autoholder.select(".default").first().setStyle({display:"block"});this.resultsshown=false}else{this.resultsshown=true;this.autoresults.setStyle({display:"block"}).update("");
if(this.options.get("regexSearch")){var b=this.options.get("wordMatch")?RegExp("(^|\\s)"+RegExp.escape(a),!this.options.get("caseSensitive")?"i":""):RegExp(RegExp.escape(a),!this.options.get("caseSensitive")?"i":"");c=this.data.filter(function(g){return g?b.test(g.evalJSON(true).caption):false})}else{var c=[];if(a){this.options.get("caseSensitive")||(a=a.toLowerCase());for(var d=0,e=0,h=this.data_searchable.length;e<h;e++)if(this.data_searchable[e].indexOf(a)>=0){var l=this.data[e];if(l!==undefined)c[d++]=
l}}}if(this.options.get("sortResults"))c=this.options.get("sortFunction")?c.sort(this.options.get("sortFunction")):c.sortBy(function(g){return g.evalJSON(true).caption});var k=0,m=0,f=null;if(this.isSearchInsertable(a)){k++;m++;f=new Element("li");f.addClassName("add-value-special-element");f.cacheData("result",{caption:a,value:a,newValue:true});f.cacheData("input",this.inputElem);f.observe("click",function(g){g.stop();this.current_input="";this.autoAdd(f)}.bindAsEventListener(this)).observe("mouseover",
function(){this.autoFocus(f)}.bindAsEventListener(this)).update("Add <b>"+a+"</b>");this.autoresults.insert(f)}c.each(function(g,n){k++;if(!(n>=(this.options.get("maxResults")?this.options.get("maxResults"):this.loptions.get("autocomplete").maxresults)-m)){el=this.addToAutocomplete(g,a);n==0&&this.autoFocus(el)}},this);m==k&&this.autoFocus(f)}if(!this.options.get("pinAutoHolder"))if(k==0){this.autocurrent=false;this.autoHide()}else this.autoSizeHolder(k);return this}},autoSizeHolder:function(a){if(this.autoresults.firstDescendant()){var b=
this.autoresults.firstDescendant().offsetHeight+1;a>this.options.get("results")?this.autoresults.setStyle({height:this.options.get("results")*b+"px"}):this.autoresults.setStyle({height:(a?a*b:0)+"px"})}},autoHighlight:function(a,b){return a.entitizeHTML().unescapeHTML().gsub(RegExp(RegExp.escape(b),"i"),function(c){return"<em>"+c[0]+"</em>"}).gsub(/<(?!\/?em>)/,"&lt;")},autoHide:function(){if(!this.options.get("pinAutoHolder")){this.resultsshown=false;this.autoholder.hide()}return this},autoFocus:function(a){if(!a)return null;
this.autocurrent&&this.autocurrent.removeClassName("auto-focus");this.autocurrent=a.addClassName("auto-focus");return this},autoMove:function(a){if(!this.resultsshown)return null;this.autoFocus(this.autocurrent[a=="up"?"previous":"next"]());this.autoresults.scrollTop=this.autocurrent.positionedOffset()[1]-this.autocurrent.getHeight();return this},setDefaultDisplay:function(){i_max=Math.min(this.options.get("defaultDisplay"),this.data.length);this.autoresults.setStyle({display:"block"}).update();for(j=
i=0;i<i_max&&j<this.data.length;){if(typeof this.data[j]!="undefined"){this.addToAutocomplete(this.data[j]);i++}j++}},addToAutocomplete:function(a,b){var c=this,d=new Element("li"),e=a.evalJSON(true),h=e.caption;d.observe("click",function(l){l.stop();c.current_input="";c.autoAdd(this)}).observe("mouseover",function(){c.autoFocus(this)});this.options.get("renderItem")?d.update(this.options.get("renderItem")(e)):d.update(this.autoHighlight(h,b));this.autoresults.insert(d);d.cacheData("result",a.evalJSON(true));
return d},autoFeed:function(a){var b=this.options.get("caseSensitive");if(this.data.indexOf(Object.toJSON(a))==-1){this.data.push(Object.toJSON(a));a=Object.toJSON(a).evalJSON(true).caption.unentitizeHTML();this.data_searchable.push(b?a:a.toLowerCase())}return this},autoAdd:function(a){if(!a||!a.retrieveData("result"))return null;this.current_input="";a=a.retrieveData("result");if(a.newValue)values=a.caption.split(/,/).each(function(b){b&&b!=""&&this.isSearchInsertable(b)&&this.autoAddSingle({caption:b,
value:b,newValue:true})}.bindAsEventListener(this));else this.autoAddSingle(a);a=this.lastinput||this.current.retrieveData("input");this.autoHide();a.retrieveData("resizable").clear().focus();return this},autoAddSingle:function(a){this.add(a);this.options.get("onUserAdd")(a);delete this.data[this.data.indexOf(Object.toJSON(a))]},autoResize:function(){this.autoholder.setStyle({width:this.holder.getWidth()+"px"})},createInput:function($super,b){var c=$super(b),d=c.retrieveData("input");d.observe("keydown",
function(e){this.newvalue=this.dosearch=false;switch(e.keyCode){case Event.KEY_UP:e.stop();return this.autoMove("up");case Event.KEY_DOWN:e.stop();return this.autoMove("down");case Event.KEY_RETURN:case Event.KEY_TAB:var h=this.current.retrieveData("input").getValue();if(h.blank()){this.options.get("onEmptyInput")();this.autocurrent=false}e.stop();this.autocurrent&&RegExp(RegExp.escape(h),"i").test(this.autocurrent.retrieveData("result").caption.unentitizeHTML())?this.autoAdd(this.autocurrent):this.autoHide();
this.current_input="";this.autocurrent=false;this.autoenter=true;break;case Event.KEY_ESC:this.autocurrent=false;this.autoHide();break;default:this.dosearch=true}return null}.bind(this));d.observe("keyup",function(e){switch(e.keyCode){case Event.KEY_COMMA:case Event.KEY_RETURN:case Event.KEY_TAB:case Event.KEY_UP:case Event.KEY_DOWN:case Event.KEY_ESC:break;default:this.current_input=this.options.get("encodeEntities")?d.value.strip().entitizeHTML():d.value.strip().escapeHTML();this.update();this.searchTimeout&&
clearTimeout(this.searchTimeout);this.searchTimeout=setTimeout(function(){if(this.dosearch){this.autocurrent=false;this.autoShow(d.value.escapeHTML())}}.bind(this),this.options.get("autoDelay"))}}.bind(this));d.observe(Prototype.Browser.IE?"keydown":"keypress",function(e){e.keyCode==Event.KEY_RETURN&&this.autoenter&&e.stop();this.autoenter=false}.bind(this));return c},createBox:function($super,b,c){b=Object.clone(b);if(this.options.get("renderBox"))b=this.options.get("renderBox")(b);c=$super(b,c);
c.observe("mouseover",function(){this.addClassName("bit-hover")}).observe("mouseout",function(){this.removeClassName("bit-hover")});return c},createAutoholder:function(a){a=new Element("div",{id:a,"class":"autocomplete"});var b=new Element("ul",{"class":"feed"});if(this.options.get("defaultMessage").length){var c=(new Element("div",{"class":"default"})).update(this.options.get("defaultMessage"));a.insert(c)}a.insert(b);this.element.insert({after:a});return a},loadFromFetchFile:function(){new Ajax.Request(this.options.get("fetchFile"),
{method:this.options.get("fetchMethod"),parameters:this.options.get("fetchParameters"),onSuccess:function(a){a.responseText.evalJSON(true).each(function(b){this.autoFeed(b)}.bind(this));this.options.get("loadFromInput")&&this.loadFromInput();this.options.get("defaultDisplay")>0&&this.setDefaultDisplay()}.bind(this)})},loadFromInput:function(){if(this.options.get("jsonInputValue")){var a=this.element.value.evalJSON(true);this.data.length&&a.each(function(b){this.add(b);b.newValue||delete this.data[this.data.indexOf(Object.toJSON(b))]}.bindAsEventListener(this))}else{a=
this.element.value.split(this.options.get("separator")).invoke("strip");this.data.length&&this.data.select(function(b){return a.include(b.evalJSON(true).value)}).each(function(b){b=b.evalJSON(true);this.add({value:b.value,caption:b.caption});delete this.data[this.data.indexOf(Object.toJSON(b))];a=a.without(b.value)},this);a.each(function(b){b.empty()||this.add({value:b,caption:b})},this)}}});
